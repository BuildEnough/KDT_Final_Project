{% extends 'base.html' %}

{% load static %}
{% load widget_tweaks %}
{% load django_bootstrap5 %}
{% load imagekit %}
{% load humanize %}

{% block title %}{% endblock title %}
{% block style %}{% endblock style %}
{% block content %}
<div class="detail_container mt-5">
  <section class="d-flex justify-content-between">
    <!-- 상품 title -->
    <div class="d-flex flex-column justify-content-end fs-3">
      {{ product.title }}
      <!-- 트윙클 램프 스노우볼 크리스마스 오르골 무드등 장식 소품 4type -->
    </div>
    <div class="d-flex">
      <div class="circle me-2 d-flex justify-content-center align-items-center">
        <i class="fas fa-arrow-up-from-bracket fs-4"></i>
      </div>
    </div>  
  </section>

  <!-- title 수평선 -->
  <hr class="detail_hr"/>

  <section class="row d-flex mt-5">
    <!-- 상품 이미지 -->
    <div class="detail_img col-6">
      <img id="big-img" class="w-100 h-100 rounded" src="{{ product.productimages_set.all.0.images }}" alt="product.productimages_set.all.0.images">
      <!-- 작은 사진들 (이미지 바꾸기) -->
      <div class="d-flex justify-content-center mt-3">
        <img class="small-img" src="{{ product.productimages_set.all.0.images }}" alt="">
        <img class="small-img" src="https://img1.kakaocdn.net/thumb/C320x320@2x.q82.fwebp/?fname=https%3A%2F%2Fst.kakaocdn.net%2Fproduct%2Fgift%2Fproduct%2F20211111144222_b541aa8be72c4b7f8e4fc3996fca6d5d.jpg" alt="">
        <img class="small-img" src="https://img1.kakaocdn.net/thumb/C320x320@2x.q82.fwebp/?fname=https%3A%2F%2Fst.kakaocdn.net%2Fproduct%2Fgift%2Fproduct%2F20211111144219_4917ff2d045a424b8af47210f332a5ec.jpg" alt="">
      </div>
    </div>
    <div class="col-6 d-flex justify-content-between ms-5">
      <div>
        <!-- 최저가 -->
        <div class="d-flex justify-content-between fs-2">
          <div>최저가</div>
          <div>{{ product.price|intcomma }}원</div>
        </div>
        <div class="d-flex justify-content-between">
          <!-- 별 평점 -->
          <div class="mt-2">⭐⭐⭐⭐⭐ (평점 {{ rating_avg }})</div>
          <!-- 공유 / 하트(위시) 버튼 -->
          <div class="mt-5 pt-4 d-flex">
            <div class="circle me-2 d-flex justify-content-center align-items-center">
              <i class="fas fa-arrow-up-from-bracket fs-4"></i>
            </div>
            <div class="heart text-center">
              {% if request.user.is_authenticated %}
                {% if request.user in product.like_user.all %}
                  <i id='like-btn' data-product-id="{{ product.pk }}" class="bi bi-heart-fill"></i>
                {% else %}
                  <i id='like-btn' data-product-id="{{ product.pk }}" class="bi bi-heart"></i>
                {% endif %}
              {% endif %}
              <span id="like-count">{{ product.like_user.count }}</span>
            </div>
          </div>
        </div>
        <!-- 카테고리 -->
        <div class="category my-3 py-3">{{ product.get_category_display }}</div>
        <!-- 비교 사이트들 -->
        <div class="d-flex justify-content-between">
          <div>
            <div>쿠팡</div>
            <div>위메프</div>
            <div>11번가</div>
            <div>G마켓</div>
            <div>인터파크</div>
            <div>롯데ON</div>
            <div>TMON</div>
          </div>
          <div>
            <div>30,000원</div>
            <div>30,000원</div>
            <div>30,000원</div>
            <div>30,000원</div>
            <div>30,000원</div>
            <div>30,000원</div>
            <div>30,000원</div>
          </div>
        </div>
      </div>
      <!-- 구매하기 버튼 -->
      <div class="my-3">
        <a href="https://www.google.com" class="buy">구매하기</a>
      </div>
    </div>
  </section>

  <!-- 탭 이동 -->
  <section id="tap-move" class="d-flex flex-column align-items-center">
    <div class="tap-nav w-100">
      <button class="tab-button" data-tab-section="tab-section-1">상품설명</button>
      <button class="tab-button" data-tab-section="tab-section-2">선물후기 ({{ product.review_set.all.count }})</button>
    </div>
    <div id="tab-section-1" class="tab-section">
      <img src="https://st.kakaocdn.net/product/gift/editor/GE9npJp40gjy0AXfoEEiCA/rNHKB8eNAErn5vVFdAkGA4DVXYsilLuZuGpJ5GG3kV8.jpg" alt="">
    </div>
    <div id="tab-section-2" class="tab-section w-100" hidden>
      <div class="d-flex justify-content-between p-4">
        <div class="fs-2">선물후기 {{ product.review_set.all.count }}</div>
        {% if request.user.is_authenticated %}
          <a href="{% url 'articles:review_create' product.pk %}">후기작성하기</a>
        {% endif %}
        <div>최신순 | 추천순</div>
      </div>
      {% for review in product.review_set.all %}
        <div class="com p-4" data-bs-toggle="modal" data-bs-target="#exampleModal{{ review.pk }}">
          <div class="d-flex">
            <div class="user_img me-3">
              {% if review.user.image %}
                <img class="w-100 h-100" src="{{ review.user.image.url }}" alt="">
              {% endif %}
            </div>
            <div class="pt-2">
              <div>{{ review.user.nickname }}</div>
              <div class="d-flex mt-1">
                <!-- 후기 평점 -->
                {% if review.rating == 1 %}
                  <div class="stars">
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star eee"></i>
                    <i class="fas fa-star eee"></i>
                    <i class="fas fa-star eee"></i>
                    <i class="fas fa-star eee"></i>
                  </div>
                {% elif review.rating == 2 %}
                  <div class="stars">
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star eee"></i>
                    <i class="fas fa-star eee"></i>
                    <i class="fas fa-star eee"></i>
                  </div>
                {% elif review.rating == 3 %}
                  <div class="stars">
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star eee"></i>
                    <i class="fas fa-star eee"></i>
                  </div>
                {% elif review.rating == 4 %}
                  <div class="stars">
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star eee"></i>
                  </div>
                {% elif review.rating == 5 %}
                  <div class="stars">
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                  </div>
                {% endif %}
                &nbsp;| {{ review.created_at.date }}        
              </div>
            </div>
          </div>
          <div class="d-flex justify-content-between mt-2">
            <div class="com_width">
              {{ review.content }}
            </div>
            <div class="com_img">
              {% if review.image %}
                <img class="w-100 h-100" src="{{ review.image.url }}" alt="">
              {% endif %}
            </div>
          </div>

        </div>
        <div>
        {% if request.user.is_authenticated %}
          {% if request.user in review.good_user.all %}
            <img src="https://emojipedia-us.s3.dualstack.us-west-1.amazonaws.com/thumbs/120/apple/325/grinning-face_1f600.png" id='good-btn' data-review-id="{{ review.pk }}" class="bi bi-emoji-smile-fill"></i>
          {% else %}
            <img src="https://emojipedia-us.s3.dualstack.us-west-1.amazonaws.com/thumbs/120/apple/325/grinning-face_1f600.png" id='good-btn' data-review-id="{{ review.pk }}" class="bi bi-emoji-smile"></i>
          {% endif %}
          <span class="emoji-count" id="good-count">{{ review.good_user.count }}</span> 
          {% if request.user in review.cool_user.all %}
            <i id='cool-btn' data-review-id="{{ review.pk }}" class="bi bi-emoji-sunglasses-fill"></i>
          {% else %}
            <i id='cool-btn' data-review-id="{{ review.pk }}" class="bi bi-emoji-sunglasses"></i>
          {% endif %}
          <span id="cool-count">{{ review.cool_user.count }}</span> 
          {% if request.user in review.fun_user.all %}
            <i id='fun-btn' data-review-id="{{ review.pk }}" class="bi bi-emoji-laughing-fill"></i>
          {% else %}
            <i id='fun-btn' data-review-id="{{ review.pk }}" class="bi bi-emoji-laughing"></i>
          {% endif %}
          <span id="fun-count">{{ review.fun_user.count }}</span> 
          {% if request.user in review.sad_user.all %}
            <i id='sad-btn' data-review-id="{{ review.pk }}" class="bi bi-emoji-frown-fill"></i>
          {% else %}
            <i id='sad-btn' data-review-id="{{ review.pk }}" class="bi bi-emoji-frown"></i>
          {% endif %}
          <span id="sad-count">{{ review.sad_user.count }}</span> 
        {% endif %}
        </div>
      {% endfor %}
    </div>
  </section>
</div>

{% for review in product.review_set.all %}
<!-- Modal -->
  <div class="modal fade" id="exampleModal{{ review.pk }}" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="exampleModalLabel">{{ review.title }}</h1>
        </div>
        <div class="modal-body">
          <div class="d-flex">
            <div class="user_img me-3">
              {% if review.user.image %}
                <img src="{{ review.user.image.url }}" alt="">
              {% endif %}
            </div>
            <div class="pt-2">
              <div>{{ review.user.nickname }}</div>
              <!-- 후기 평점 (modal) -->
              <div class="d-flex mt-1">
                {% if review.rating == 1 %}
                  <div class="stars">
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star eee"></i>
                    <i class="fas fa-star eee"></i>
                    <i class="fas fa-star eee"></i>
                    <i class="fas fa-star eee"></i>
                  </div>
                {% elif review.rating == 2 %}
                  <div class="stars">
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star eee"></i>
                    <i class="fas fa-star eee"></i>
                    <i class="fas fa-star eee"></i>
                  </div>
                {% elif review.rating == 3 %}
                  <div class="stars">
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star eee"></i>
                    <i class="fas fa-star eee"></i>
                  </div>
                {% elif review.rating == 4 %}
                  <div class="stars">
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star eee"></i>
                  </div>
                {% elif review.rating == 5 %}
                  <div class="stars">
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                  </div>
                {% endif %}
                &nbsp;| {{ review.created_at.date }}
              </div>
            </div>
          </div>
          <div class="my-3">
            {{ review.content }}
          </div>
          <div style="width: 15rem; height: 15rem;">
            <img class="w-100 h-100" src="{{ review.image.url }}" alt="review.image">
          </div>
          <form id="comment-form" data-review-id="{{ review.pk }}">
            {% csrf_token %}
            {% bootstrap_form review_comment_form %}
            <input type="submit">
          </form>
          <div id="comment-box{{ review.pk }}">
            {% for comment in review.reviewcomment_set.all %}
              <div>
                {{ comment.content }} / <a href="{% url 'accounts:detail' comment.user.pk %}">{{ comment.user.nickname }}</a>
                {% if request.user == comment.user %}
                  <a a class='btn btn-sm btn-outline-danger' href="{% url 'articles:review_comment_delete' comment.pk %}">삭제</a>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="modal_btn" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </section>
  </div>
{% endfor %}
{% endblock content %}

{% block script %}
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<!-- 위시리스트 비동기 -->
<script>
  const likeBtn = document.querySelector('#like-btn')
  likeBtn.addEventListener('click', function (event) {
    console.log(event.target.dataset)
    axios({
      url: `/${event.target.dataset.productId}/like/`
    })
    .then(response => {
      console.log(response)
      console.log(response.data)
      if (response.data.isLiked === true) {
        event.target.classList.add('bi-heart-fill')
        event.target.classList.remove('bi-heart')
      } else {
        event.target.classList.add('bi-heart')
        event.target.classList.remove('bi-heart-fill')
      }
      const likeCount = document.querySelector('#like-count')
      likeCount.innerText = response.data.likeCount
    })
  })
</script>

<!-- 댓글작성 비동기 -->
<script>
const commentForms = document.querySelectorAll('#comment-form')
for (let commentForm of commentForms) {
  commentForm.addEventListener('submit', function(event) {
    let csrftoken = event.target.querySelector('[name=csrfmiddlewaretoken]').value
    event.preventDefault();
    axios({
      method: 'post',
      url: `/${event.target.dataset.reviewId}/review_comment_create/`,
      headers: {
        'X-CSRFToken': csrftoken
      },
      data: new FormData(commentForm)
    }).then(response => {
      let commentBox = document.querySelector(`#comment-box${event.target.dataset.reviewId}`)
      commentBox.replaceChildren()
      for (comment of response.data.comments) {
        let div1 = document.createElement('div')
        let a1 = document.createElement('a')
        a1.setAttribute('href', `/accounts/${comment[3]}/detail/`)
        a1.innerText = comment[1]
        div1.innerText = `${comment[0]} / `
        div1.append(a1)
        if (comment[3] === comment[4]) {
          let a2 = document.createElement('a')
          a2.setAttribute('href', `/${comment[5]}/review_comment_delete/`)
          a2.classList.add('btn', 'btn-sm', 'btn-outline-danger')
          a2.innerText = '삭제'
          div1.append(a2)
        }
        commentBox.append(div1)
      }
      commentForm.reset()
    })
  })
}
</script>

<script>
  const $nav = document.querySelector('#tap-move')
    const $sections = document.querySelectorAll('.tab-section');

    $nav.addEventListener('click', (e) => {
      if (!e.target.classList.contains('tab-button')) {
        return;
      }
      
      const focusedTabId = e.target.dataset.tabSection;

      $sections.forEach(($section) => {
        if ($section.id === focusedTabId) {
          $section.removeAttribute('hidden');
        } else {
          $section.setAttribute('hidden', true);
        }
      });
    });
</script>
<script>
  var bigPic = document.querySelector('#big-img');
  var smallPics = document.querySelectorAll('.small-img');

  for(var i=0; i<smallPics.length; i++){
    smallPics[i].onclick = changePic;
  }

  function changePic(){
    var smallPicAttribute = this.getAttribute('src');
    bigPic.setAttribute('src', smallPicAttribute);
  }
</script>




<script>
  const goodBtn = document.querySelector('#good-btn')
  goodBtn.addEventListener('click', function (event) {
    console.log(event.target.dataset)
    axios({
      url: `/${event.target.dataset.reviewId}/review_good/`
    })
    .then(response => {
      console.log(response)
      console.log(response.data)
      if (response.data.isGooded === true) {
        event.target.classList.add('bi', 'bi-emoji-smile-fill', 'emoji-count')
        event.target.classList.remove('bi', 'bi-emoji-smile')
      } else {
        event.target.classList.add('bi', 'bi-emoji-smile')
        event.target.classList.remove('bi', 'bi-emoji-smile-fill')
      }
      const goodCount = document.querySelector('#good-count')
      goodCount.innerText = response.data.goodCount
    })
  })
</script>




{% endblock script %}